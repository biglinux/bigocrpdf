# Maintainer: Bruno Goncalves <bigbruno@gmail.com>

pkgname=bigocrpdf
pkgdesc="The simplest way to apply OCR to your PDF files, making it possible to search and copy texts from scanned files."

depends=(
	'gtk4'
	'libadwaita'
	'python'
	'python-gobject'
	'python-cairo'
	# RapidOCR core
	'python-rapidocr'
	'rapidocr-fonts'
	# Default language models (Latin covers most Western languages)
	'rapidocr-models-mobile-latin'
	'rapidocr-models-mobile-base'
	# OCR inference backend
	'python-openvino'
	# PDF processing
	'python-pikepdf'
	'python-pillow'
	'python-reportlab'
	'poppler'
	# Image processing
	'python-opencv'
	'python-numpy'
	# Dewarp dependencies (for curved page correction)
	'python-scipy'
	# ODF export
	'python-odfpy'
	# BiDi text support (Arabic, Hebrew)
	'fribidi'
)

makedepends=(
	'python-build'
	'python-installer'
	'python-setuptools'
	'python-wheel'
)

pkgver=$(date +%y.%m.%d)
pkgrel=$(date +%H%M)
arch=('any')
license=('GPL-3.0-or-later')
url="https://github.com/biglinux/bigocrpdf"

optdepends=(
	# RapidOCR language models
	'rapidocr-models-mobile-arabic: Arabic script OCR'
	'rapidocr-models-mobile-korean: Korean OCR'
	'rapidocr-models-mobile-cyrillic: Cyrillic script OCR (Russian, Ukrainian, etc.)'
	'rapidocr-models-mobile-devanagari: Devanagari script OCR (Hindi, etc.)'
	'rapidocr-models-mobile-english: English OCR (optimized)'
	'rapidocr-models-mobile-greek: Greek OCR'
	'rapidocr-models-mobile-slavic: Slavic languages OCR'
	'rapidocr-models-mobile-tamil: Tamil OCR'
	'rapidocr-models-mobile-telugu: Telugu OCR'
	'rapidocr-models-mobile-thai: Thai OCR'
	# Server models for higher accuracy
	'rapidocr-models-server: Server models for higher accuracy'
	# Alternative inference backend
	'python-onnxruntime: Alternative inference backend (fallback)'
	# PDF/A ICC profile fallback
	'ghostscript: sRGB ICC profile for PDF/A-2b conversion'
)
source=("git+https://github.com/biglinux/bigocrpdf.git")
md5sums=('SKIP')

build() {
	cd "${srcdir}/${pkgname}"
	python -m build --wheel --no-isolation --skip-dependency-check
}

package() {
	cd "${srcdir}/${pkgname}"

	# Install Python wheel
	python -m installer --destdir="$pkgdir" dist/*.whl

	# Install additional files (icons, desktop files, translations, etc.)
	# Exclude bin directory to avoid conflict with python-installer (bigocrpdf)
	# and handle bigocrimage separately
	if [ -d "usr/share" ]; then
		cp -a usr/share "${pkgdir}/usr/"
	fi

	# Manually install bigocrimage script
	if [ -f "usr/bin/bigocrimage" ]; then
		install -Dm755 usr/bin/bigocrimage "${pkgdir}/usr/bin/bigocrimage"
	fi
	
	# Manually install bigocrpdf script (separate from wheel to preserve custom wrapper)
	if [ -f "usr/bin/bigocrpdf" ]; then
		install -Dm755 usr/bin/bigocrpdf "${pkgdir}/usr/bin/bigocrpdf"
	fi

	# Install license file
	if [ -f "LICENSE" ]; then
		install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
	fi

	# Install documentation
	if [ -f "README.md" ]; then
		install -Dm644 README.md "${pkgdir}/usr/share/doc/${pkgname}/README.md"
	fi
}
